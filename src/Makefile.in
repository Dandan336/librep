# Makefile.in -- input for the src directory's Makefile
# Copyright (C) 1998 John Harper <john@dcs.warwick.ac.uk>
# $Id$
#
# This file is part of Jade.
#
# Jade is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# Jade is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Jade; see the file COPYING.  If not, write to
# the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.

top_builddir=..
VPATH=@top_srcdir@/src:.

COMMON_SRCS =	continuations.c datums.c debug-buffer.c files.c find.c \
		fluids.c lisp.c lispcmds.c lispmach.c macros.c main.c \
		message.c misc.c numbers.c regexp.c regsub.c streams.c \
		structures.c symbols.c values.c
UNIX_SRCS =	unix_dl.c unix_files.c unix_main.c unix_processes.c

INSTALL_HDRS = rep.h rep_lisp.h rep_regexp.h rep_subrs.h

SRCS = $(COMMON_SRCS) $(UNIX_SRCS)
OBJS = $(SRCS:.c=.lo)

SDBM_SRCS = sdbm.c sdbm_pair.c sdbm_hash.c
SDBM_OBJS = $(SDBM_SRCS:.c=.o)
SDBM_LOBJS = $(SDBM_SRCS:.c=.lo)

DL_SRCS = repsdbm.c timers.c gettext.c readline.c tables.c repgdbm.c
DL_OBJS = sdbm.la timers.la gettext.la readline.la tables.la gdbm.la

REP_SRCS =	rep.c
REP_OBJS =	$(REP_SRCS:.c=.o)

INTL_OBJS_yes=../intl/*.lo
INTL_OBJS_no=
INTL_OBJS=$(INTL_OBJS_@USE_INCLUDED_LIBINTL@)

all : librep.la $(DL_OBJS) rep rep-config rep-remote rep-xgettext

librep.la : $(OBJS) $(LIBOBJS) $(ALLOCA)
	$(LIBTOOL) $(CC) $(LDFLAGS) -version-info $(libversion) \
	  -o $@ $^ -rpath $(libdir)

rep : $(REP_OBJS) $(EXTRA_LIBOBJS) librep.la
	$(LIBTOOL) $(CC) -export-dynamic $(CPPFLAGS) $(CFLAGS) -o $@ \
	  $(REP_OBJS) librep.la $(EXTRA_LIBOBJS) $(LIBS) $(GMP_LIBS)

rep-remote : rep-remote.c

rep-xgettext : rep-xgettext.jl rep
	$(COMPILE_ENV) $(rep_prog) --batch -l compiler -f compile-batch $< \
	  && mv $<c $@ && chmod +x $@

install : all installdirs
	$(LIBTOOL) $(INSTALL_PROGRAM) librep.la $(DESTDIR)${libdir}
	$(LIBTOOL) -n --finish $(DESTDIR)${libdir}
	$(LIBTOOL) $(INSTALL_PROGRAM) -m 755 rep $(DESTDIR)${bindir}
	$(LIBTOOL) $(INSTALL_PROGRAM) -m 755 repdoc $(DESTDIR)${bindir}
	$(INSTALL_SCRIPT) -m 755 rep-config $(DESTDIR)${bindir}
	$(INSTALL_SCRIPT) -m 755 rep-xgettext $(DESTDIR)${bindir}
	$(INSTALL_PROGRAM) -m 755 rep-remote $(DESTDIR)${bindir}
	for dl in $(DL_OBJS); do \
	  $(LIBTOOL) $(INSTALL_PROGRAM) $$dl $(DESTDIR)${repexecdir}; \
	done
	printf "\nrep_open_globally=yes\n" >>$(DESTDIR)${repexecdir}/gettext.la
	for i in $(INSTALL_HDRS); do \
	  $(INSTALL_DATA) $$i $(DESTDIR)$(includedir); \
	done

installdirs : $(top_srcdir)/mkinstalldirs
	$(SHELL) $(top_srcdir)/mkinstalldirs $(DESTDIR)$(libdir) $(DESTDIR)$(bindir) \
	  $(DESTDIR)$(repexecdir) $(DESTDIR)$(includedir)

uninstall :
	$(LIBTOOL) rm $(DESTDIR)${libdir}/librep.la
	$(LIBTOOL) rm $(DESTDIR)${bindir}/rep
	$(LIBTOOL) rm $(DESTDIR)${bindir}/repdoc
	rm -f $(DESTDIR)${bindir}/rep-config
	rm -f $(DESTDIR)${bindir}/rep-xgettext
	rm -f $(DESTDIR)${bindir}/rep-remote
	for dl in $(DL_OBJS); do \
	  $(LIBTOOL) rm $(DESTDIR)${repexecdir}/$$dl; \
	done
	for i in $(INSTALL_HDRS); do \
	  rm $(DESTDIR)$(includedir)/$$i; \
	done
	
rep-config : rep-config.sh
	$(SHELL) $< "${prefix}" "${libdir}" "${version}" \
	  "${LIBS} ${GMP_LIBS}" "${repcommonexecdir}">$@
	chmod +x $@

repdoc : repdoc.o
	$(LIBTOOL) $(CC) $(LDFLAGS) -o $@ $^ $(GDBM_LIBS)

sdbm.la : $(SDBM_LOBJS) repsdbm.lo
	$(LIBTOOL) $(CC) $(LDFLAGS) -avoid-version -module -o $@ \
	 $(SDBM_LOBJS) repsdbm.lo -rpath $(repexecdir)

gdbm.la : repgdbm.lo
	$(LIBTOOL) $(CC) $(LDFLAGS) -avoid-version -module -o $@ \
	 $^ $(GDBM_LIBS) -rpath $(repexecdir)

gettext.la : gettext.lo
	$(LIBTOOL) $(CC) $(LDFLAGS) -avoid-version -module -o $@ \
	 $^ $(INTL_OBJS) -rpath $(repexecdir)

readline.la : readline.lo
	$(LIBTOOL) $(CC) $(LDFLAGS) -avoid-version -module -o $@ \
	 $^ $(READLINE_LIBS) -rpath $(repexecdir)

callcc.la : continuations.lo
	$(LIBTOOL) $(CC) $(LDFLAGS) -avoid-version -module -o $@ \
	 $^ -rpath $(repexecdir)

clean :
	rm -f *~ *.o *.lo *.la build.h
	rm -f repdoc core rep rep-remote

realclean : clean
	rm -f .*.d Makefile rep.h dump.out dumped.s rep-config
	rm -rf .libs

include $(SRCS:%.c=.%.d) $(DL_SRCS:%.c=.%.d) $(REP_SRCS:%.c=.%.d)
